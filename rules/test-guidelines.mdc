---
description: Guideline for writing tests - Read before adding or modifying tests
globs:
alwaysApply: false
---
## TDD: Tests Come FIRST

Write tests BEFORE production code. See [coding-guidelines.mdc](mdc:rules/coding-guidelines.mdc).

| Task | Workflow |
|------|----------|
| New feature | Write scenario → verify it fails → write minimal code to pass |
| Modify feature | Update scenario first → verify failure → update code |
| Fix bug | Write scenario reproducing bug → verify failure → fix |

## BDD Framework

- **Unit/Integration** (`features/unit/`, `features/integration/`): quickpickle + vitest. Steps in `tests/steps/`. Run: `npm run test:unit`
- **E2E** (`features/e2e/`): playwright-bdd. Steps in `tests/e2e/steps/`. Run: `npm run test:e2e`

## Writing Scenarios

- **Behavior, not implementation**: Test WHAT, not HOW
- **One behavior per scenario**: Small cycles, easy diagnosis
- **Concrete examples**: Specific values, not vague descriptions
- **Typed step definitions**: All parameters and returns must have types

## Mocks

Minimize mocks. Only mock external dependencies (APIs, databases). Mocking user code is rare—ask first.

## When Tests Fail

- **After you wrote it (RED phase)**: Expected. Now write code to pass.
- **Unexpectedly**: STOP. Investigate before changing anything.
- **Wrong test assumption**: Fix the test, not the code. Example: test passes None to function that doesn't accept None → fix test, don't change function.

Test setup code lives in `tests/`, not production code.
